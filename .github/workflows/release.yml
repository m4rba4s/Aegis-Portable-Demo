name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-release:
    name: Build Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build with Docker
        run: |
          docker build --output=dist .
          ls -la dist/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum aegis-cli aegis.o aegis-tc.o > SHA256SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/aegis-cli
            dist/aegis.o
            dist/aegis-tc.o
            dist/SHA256SUMS
          body: |
            ## Aegis eBPF Firewall ${{ github.ref_name }}

            ### Quick Install
            ```bash
            curl -sSfL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | sudo bash
            ```

            ### Pre-built Binary
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/aegis-cli
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SHA256SUMS
            sha256sum -c SHA256SUMS
            chmod +x aegis-cli
            sudo install aegis-cli /usr/local/bin/
            sudo aegis-cli -i eth0 tui
            ```

            ### Supported Platforms
            - Fedora / RHEL / CentOS / Rocky
            - Ubuntu / Debian / Pop!_OS
            - Arch / Manjaro
            - Alpine (OpenRC)
            - openSUSE

            ### Files
            | File | Description |
            |------|-------------|
            | `aegis-cli` | Main binary (eBPF embedded) |
            | `aegis.o` | XDP object (advanced) |
            | `aegis-tc.o` | TC object (advanced) |
            | `SHA256SUMS` | Integrity checksums |
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
